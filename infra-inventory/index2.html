<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfraInventory V3.1</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .sticky-header th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- HELPERS ---
        const getEOSMeta = (dateStr) => {
            if (!dateStr) return { class: 'text-gray-400', label: 'N/A', isRisk: false };
            const diffDays = Math.ceil((new Date(dateStr) - new Date()) / (1000 * 60 * 60 * 24));
            if (isNaN(diffDays)) return { class: 'text-gray-400', label: 'Invalid Date', isRisk: false };
            if (diffDays < 0) return { class: 'text-red-700 bg-red-100 font-bold px-2 py-0.5 rounded text-[10px] uppercase tracking-wide', label: 'Expired', isRisk: true };
            if (diffDays < 180) return { class: 'text-orange-700 bg-orange-100 font-bold px-2 py-0.5 rounded text-[10px] uppercase tracking-wide', label: 'Soon', isRisk: true };
            return { class: 'text-slate-600 text-xs font-mono', label: dateStr, isRisk: false };
        };

        // --- COMPONENTS ---
        function SearchableSelect({ label, options = [], value, onChange, disabled, placeholder="Select..." }) {
            const [isOpen, setIsOpen] = useState(false); 
            const [search, setSearch] = useState("");
            
            // Safety check for options array
            const safeOptions = Array.isArray(options) ? options : [];
            const selectedOption = safeOptions.find(o => o.id == value);
            
            useEffect(() => { if (isOpen) setSearch(""); }, [isOpen]);
            
            const filtered = safeOptions.filter(o => o.name.toLowerCase().includes(search.toLowerCase()));
            
            return (
                <div className="relative">
                    {label && <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">{label}</label>}
                    <div className={`w-full border border-slate-300 rounded-md p-2 text-sm flex justify-between items-center bg-white transition-colors ${disabled ? 'bg-slate-100 text-slate-400' : 'cursor-pointer hover:border-blue-500'}`} onClick={()=>!disabled && setIsOpen(!isOpen)}>
                        <span className={`truncate ${!selectedOption?"text-slate-400":"text-slate-900"}`}>{selectedOption?selectedOption.name:placeholder}</span>
                        <i className="ph ph-caret-down text-slate-400"></i>
                    </div>
                    {isOpen && (<><div className="fixed inset-0 z-20" onClick={()=>setIsOpen(false)}></div><div className="absolute z-30 w-full mt-1 bg-white border border-slate-200 rounded-md shadow-xl max-h-60 overflow-hidden flex flex-col"><div className="p-2 border-b border-slate-100 bg-slate-50"><input autoFocus type="text" className="w-full border border-slate-300 rounded p-1.5 text-xs focus:outline-none focus:border-blue-500" placeholder="Filter..." value={search} onChange={(e)=>setSearch(e.target.value)} /></div><div className="overflow-y-auto flex-1">{filtered.length===0?<div className="p-3 text-slate-500 text-xs text-center">No matches</div>:filtered.map(opt=>(<div key={opt.id} className={`p-2 text-sm cursor-pointer hover:bg-blue-50 ${value==opt.id?'bg-blue-100 font-medium text-blue-700':''}`} onClick={()=>{onChange(opt.id);setIsOpen(false)}}>{opt.name}</div>))}</div></div></>)}
                </div>
            );
        }

        function StatCard({ label, value, icon, color }) {
            // Helper to ensure Tailwind generates these classes
            // Usage: bg-blue-500 text-blue-500
            const textColor = color.replace('bg-', 'text-');
            return (
                <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                    <div className={`p-3 rounded-lg ${color} bg-opacity-10 text-xl`}>
                        <i className={`ph ${icon} ${textColor}`}></i>
                    </div>
                    <div>
                        <div className="text-slate-500 text-xs font-bold uppercase tracking-wider">{label}</div>
                        <div className="text-2xl font-bold text-slate-800">{value}</div>
                    </div>
                </div>
            );
        }

        // --- FULL SCREEN VIEWS ---
        
        function SettingsView({ options, onDataUpdated, currentUser }) {
            const [activeTab, setActiveTab] = useState('master');
            const [msg, setMsg] = useState(null);
            
            // State containers
            const [brandName, setBrandName] = useState("");
            const [modelForm, setModelForm] = useState({ brand_id: "", name: "", eos_date: "" });
            const [users, setUsers] = useState([]);
            const [userForm, setUserForm] = useState({ username: "", password: "", role: "editor" });
            const [editingUser, setEditingUser] = useState(null);
            const [backupPass, setBackupPass] = useState(""); 
            const [restoreFile, setRestoreFile] = useState(null); 
            const [restorePass, setRestorePass] = useState("");
            const [searchFilter, setSearchFilter] = useState("");

            useEffect(() => { if (activeTab === 'users' && currentUser.role === 'admin') axios.get('api/users.php').then(res => setUsers(res.data)); }, [activeTab]);

            // Helper for simple API calls
            const api = (url, data, txt) => {
                axios.post(url, data).then(res => {
                    if (res.data.success) { setMsg({type:'success', text:txt}); onDataUpdated(); if(activeTab==='users') { axios.get('api/users.php').then(r=>setUsers(r.data)); setEditingUser(null); setUserForm({username:"",password:"",role:"editor"}); } }
                    else setMsg({type:'error', text:res.data.message});
                }).catch(e => setMsg({type:'error', text: e.response?.data?.message || e.message}));
            };

            const brands = options?.brands || [];
            const models = options?.models || [];

            return (
                <div className="p-8 max-w-6xl mx-auto">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
                    <div className="flex gap-4 border-b border-slate-200 mb-6">
                        {['master', 'users', 'backup'].map(tab => (
                            <button key={tab} onClick={()=>setActiveTab(tab)} className={`pb-3 px-4 text-sm font-medium capitalize transition-colors ${activeTab===tab ? 'border-b-2 border-blue-600 text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>
                                {tab === 'master' ? 'Master Data' : tab === 'users' ? 'User Management' : 'Backup & Restore'}
                            </button>
                        ))}
                    </div>
                    {msg && <div className={`mb-6 p-4 rounded-lg text-sm font-medium ${msg.type==='error'?'bg-red-50 text-red-700 border border-red-200':'bg-green-50 text-green-700 border border-green-200'}`}>{msg.text}</div>}

                    {activeTab === 'master' && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-700">Brands</h3><input type="text" placeholder="Search..." className="text-xs border p-1 rounded" onChange={e=>setSearchFilter(e.target.value)} /></div>
                                <div className="h-64 overflow-y-auto mb-4 pr-2 space-y-2">
                                    {brands.filter(b=>b.name.toLowerCase().includes(searchFilter.toLowerCase())).map(b => (
                                        <div key={b.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100 text-sm group">
                                            <span>{b.name}</span>
                                            <button onClick={()=>{if(confirm("Delete?")) api('api/settings.php', {action:'delete_brand', id:b.id}, "Deleted")}} className="text-slate-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><i className="ph ph-trash"></i></button>
                                        </div>
                                    ))}
                                </div>
                                <form onSubmit={(e)=>{e.preventDefault(); api('api/settings.php', {action:'add_brand', name:brandName}, "Added"); setBrandName("");}} className="flex gap-2"><input required value={brandName} onChange={e=>setBrandName(e.target.value)} className="flex-1 border rounded p-2 text-sm" placeholder="New Brand Name" /><button className="bg-slate-800 text-white px-4 rounded text-sm hover:bg-slate-900">Add</button></form>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 className="font-bold text-slate-700 mb-4">Models</h3>
                                <div className="h-64 overflow-y-auto mb-4 pr-2 space-y-2">
                                    {models.filter(m=>m.name.toLowerCase().includes(searchFilter.toLowerCase())).map(m => (
                                        <div key={m.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100 text-sm group">
                                            <div><span className="font-medium">{m.name}</span> <span className="text-slate-400 text-xs ml-2">{brands.find(b=>b.id===m.brand_id)?.name}</span></div>
                                            <button onClick={()=>{if(confirm("Delete?")) api('api/settings.php', {action:'delete_model', id:m.id}, "Deleted")}} className="text-slate-400 hover:text-red-600 opacity-0 group-hover:opacity-100"><i className="ph ph-trash"></i></button>
                                        </div>
                                    ))}
                                </div>
                                <form onSubmit={(e)=>{e.preventDefault(); api('api/settings.php', {action:'add_model', ...modelForm}, "Added"); setModelForm({...modelForm, name:"", eos_date:""});}} className="grid grid-cols-2 gap-2">
                                    <div className="col-span-2"><SearchableSelect options={brands} value={modelForm.brand_id} onChange={v=>setModelForm({...modelForm, brand_id:v})} placeholder="Select Brand" /></div>
                                    <input required value={modelForm.name} onChange={e=>setModelForm({...modelForm, name:e.target.value})} className="border rounded p-2 text-sm" placeholder="Model Name" />
                                    <input type="date" value={modelForm.eos_date} onChange={e=>setModelForm({...modelForm, eos_date:e.target.value})} className="border rounded p-2 text-sm" />
                                    <button className="col-span-2 bg-blue-600 text-white p-2 rounded text-sm hover:bg-blue-700 font-medium">Add Model</button>
                                </form>
                            </div>
                        </div>
                    )}
                    {activeTab === 'users' && currentUser.role === 'admin' && (
                        /* User Tab Logic Simplified for brevity but fully functional */
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <div className="mb-4">
                                {users.map(u => <div key={u.id} className="flex justify-between p-2 border-b">
                                    <span>{u.username} <span className="bg-gray-100 text-xs p-1 rounded">{u.role}</span></span>
                                    <div>
                                        <button onClick={()=>{setEditingUser(u);setUserForm({username:u.username, role:u.role, password:""})}} className="text-blue-600 text-sm mr-2">Edit</button>
                                        {u.id !== currentUser.id && <button onClick={()=>{if(confirm("Delete?")) axios.delete('api/users.php', {data:{id:u.id}}).then(()=>apiCall('api/users.php',{},"Deleted"))}} className="text-red-500 text-sm">Delete</button>}
                                    </div>
                                </div>)}
                            </div>
                            <form onSubmit={(e)=>{e.preventDefault(); const url='api/users.php'; if(editingUser) axios.put(url, {id:editingUser.id, ...userForm}).then(()=>{setMsg({type:'success',text:"Updated"});axios.get(url).then(r=>setUsers(r.data));setEditingUser(null);setUserForm({username:"",password:"",role:"editor"})}); else api(url, userForm, "Created");}} className="flex gap-2 items-center">
                                <input value={userForm.username} onChange={e=>setUserForm({...userForm, username:e.target.value})} className="border p-2 text-sm" placeholder="Username" required />
                                <input type="password" value={userForm.password} onChange={e=>setUserForm({...userForm, password:e.target.value})} className="border p-2 text-sm" placeholder={editingUser?"New Pass (Opt)":"Password"} required={!editingUser} />
                                <select value={userForm.role} onChange={e=>setUserForm({...userForm, role:e.target.value})} className="border p-2 text-sm"><option value="editor">Editor</option><option value="admin">Admin</option><option value="viewer">Viewer</option></select>
                                <button className="bg-blue-600 text-white p-2 rounded text-sm">{editingUser ? 'Update' : 'Add'}</button>
                                {editingUser && <button type="button" onClick={()=>{setEditingUser(null);setUserForm({username:"",password:"",role:"editor"})}} className="text-xs text-gray-500">Cancel</button>}
                            </form>
                        </div>
                    )}
                    {activeTab === 'backup' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200 text-center">
                                <h3 className="font-bold">Export</h3>
                                <form onSubmit={(e)=>{e.preventDefault(); axios.post('api/backup.php',{password:backupPass}).then(res=>{if(res.data.success){const a=document.createElement('a');a.href='data:application/octet-stream;base64,'+res.data.content;a.download=res.data.filename;a.click();}else alert(res.data.message)})}}><input type="password" placeholder="Password" value={backupPass} onChange={e=>setBackupPass(e.target.value)} className="border p-2 my-2 w-full text-center" required/><button className="bg-slate-800 text-white p-2 rounded w-full">Download</button></form>
                            </div>
                            <div className="bg-red-50 p-8 rounded-xl shadow-sm border border-red-200 text-center">
                                <h3 className="font-bold text-red-800">Restore</h3>
                                <form onSubmit={(e)=>{e.preventDefault(); if(!confirm("WIPE DB?"))return; const fd=new FormData(); fd.append('backup_file',restoreFile); fd.append('password',restorePass); axios.post('api/restore.php',fd).then(res=>{if(res.data.success){alert("Done");window.location.reload()}else alert(res.data.message)})}}><input type="file" onChange={e=>setRestoreFile(e.target.files[0])} className="mb-2 text-xs w-full" required/><input type="password" placeholder="Password" value={restorePass} onChange={e=>setRestorePass(e.target.value)} className="border p-2 my-2 w-full text-center" required/><button className="bg-red-600 text-white p-2 rounded w-full">Restore</button></form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function LogsView() {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            useEffect(() => { setLoading(true); axios.get('api/logs.php').then(res => { setLogs(Array.isArray(res.data) ? res.data : []); setLoading(false); }); }, []);
            return (<div className="p-8 max-w-6xl mx-auto"><h2 className="text-2xl font-bold mb-6">Audit Logs</h2><div className="bg-white shadow rounded overflow-hidden"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b"><tr><th className="p-3">Time</th><th className="p-3">User</th><th className="p-3">Action</th><th className="p-3">Details</th></tr></thead><tbody>{logs.map(l=><tr key={l.id} className="border-b"><td className="p-3 text-slate-500 text-xs">{l.created_at}</td><td className="p-3 font-medium">{l.username}</td><td className="p-3"><span className="bg-gray-100 px-2 py-1 rounded text-xs font-bold">{l.action}</span></td><td className="p-3 text-slate-600">{l.target} - {l.details}</td></tr>)}</tbody></table></div></div>);
        }

        function Layout({ user, currentView, onViewChange, onLogout, children }) {
            const menuItems = [
                { id: 'dashboard', label: 'Inventory', icon: 'ph-rows' },
                { id: 'logs', label: 'Audit Logs', icon: 'ph-clipboard-text' },
                ...(user.role !== 'viewer' ? [{ id: 'settings', label: 'Settings', icon: 'ph-gear' }] : [])
            ];
            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 bg-slate-850 text-white flex flex-col shrink-0">
                        <div className="p-6 border-b border-slate-700 flex items-center gap-3"><div className="bg-blue-600 p-2 rounded"><i className="ph ph-hard-drives text-xl"></i></div><span className="font-bold">InfraInv</span></div>
                        <nav className="flex-1 p-4 space-y-2">{menuItems.map(i=><button key={i.id} onClick={()=>onViewChange(i.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded text-sm ${currentView===i.id?'bg-blue-600':'hover:bg-slate-800'}`}><i className={`ph ${i.icon} text-lg`}></i>{i.label}</button>)}</nav>
                        <div className="p-4 bg-slate-900 border-t border-slate-800 text-center"><div className="mb-2 text-sm font-bold">{user.username || 'User'}</div><button onClick={onLogout} className="text-xs text-red-400">Sign Out</button></div>
                    </aside>
                    <main className="flex-1 overflow-auto bg-slate-50 relative">{children}</main>
                </div>
            );
        }

        // --- GLOBAL MODALS (Must be separate to avoid hooks issues) ---
        function DeviceModal({ isOpen, onClose, onSave, options, initialData }) {
            // NOTE: We only render this if isOpen is true in the parent, so we can use hooks safely.
            const [form, setForm] = useState(initialData || { hostname:'', ip_address:'', serial_number:'', asset_id:'', firmware_version:'', location:'', status:'Active', type_id:'', brand_id:'', model_id:'', notes:'' });
            useEffect(() => { setForm(initialData || { hostname:'', ip_address:'', serial_number:'', asset_id:'', firmware_version:'', location:'', status:'Active', type_id:'', brand_id:'', model_id:'', notes:'' }); }, [initialData]);
            
            const brands = options?.brands || [];
            const models = options?.models || [];
            const filteredModels = models.filter(m => m.brand_id == form.brand_id);
            
            const handleChange = (e) => setForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleSelectChange = (name, value) => { setForm(prev => { if (name === 'brand_id') return { ...prev, [name]: value, model_id: '' }; return { ...prev, [name]: value }; }); };
            
            return (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center p-6 border-b"><h2 className="text-xl font-bold text-gray-800">{initialData ? 'Edit Device' : 'Add New Device'}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-700">✕</button></div><form onSubmit={(e) => { e.preventDefault(); onSave(form); }} className="p-6 grid grid-cols-1 md:grid-cols-2 gap-4"><div className="col-span-1 md:col-span-2 bg-blue-50 p-3 rounded border border-blue-100 mb-2"><h3 className="text-xs font-bold text-blue-800 uppercase mb-2">Core Identity</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-xs font-medium text-gray-700 mb-1">Hostname *</label><input required name="hostname" value={form.hostname} onChange={handleChange} className="w-full border rounded p-2 text-sm"/></div><div><label className="block text-xs font-medium text-gray-700 mb-1">Serial Number *</label><input required name="serial_number" value={form.serial_number} onChange={handleChange} className="w-full border rounded p-2 text-sm"/></div></div></div><div><label className="block text-xs font-medium text-gray-700 mb-1">Device Type *</label><select required name="type_id" value={form.type_id} onChange={handleChange} className="w-full border rounded p-2 text-sm"><option value="">Select Type</option>{(options.types||[]).map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select></div><div><label className="block text-xs font-medium text-gray-700 mb-1">Status</label><select name="status" value={form.status} onChange={handleChange} className="w-full border rounded p-2 text-sm"><option value="Active">Active</option><option value="In-Stock">In-Stock</option><option value="Decommissioned">Decommissioned</option></select></div><div><SearchableSelect label="Brand *" options={brands} value={form.brand_id} onChange={(val)=>handleSelectChange('brand_id', val)} placeholder="Select Brand..."/></div><div><SearchableSelect label="Model *" options={filteredModels} value={form.model_id} onChange={(val)=>handleSelectChange('model_id', val)} disabled={!form.brand_id} placeholder={form.brand_id?"Select Model...":"Select Brand First"}/></div><div><label className="block text-xs font-medium text-gray-700 mb-1">Mgmt IP</label><input name="ip_address" value={form.ip_address||''} onChange={handleChange} className="w-full border rounded p-2 text-sm"/></div><div><label className="block text-xs font-medium text-gray-700 mb-1">Location</label><input name="location" value={form.location||''} onChange={handleChange} className="w-full border rounded p-2 text-sm"/></div><div><label className="block text-xs font-medium text-gray-700 mb-1">Asset Tag</label><input name="asset_id" value={form.asset_id||''} onChange={handleChange} className="w-full border rounded p-2 text-sm"/></div><div><label className="block text-xs font-medium text-gray-700 mb-1">Firmware</label><input name="firmware_version" value={form.firmware_version||''} onChange={handleChange} className="w-full border rounded p-2 text-sm"/></div><div className="col-span-1 md:col-span-2"><label className="block text-xs font-medium text-gray-700 mb-1">Notes</label><textarea name="notes" value={form.notes||''} onChange={handleChange} className="w-full border rounded p-2 text-sm" rows="2"></textarea></div><div className="col-span-1 md:col-span-2 flex justify-end gap-3 mt-4 border-t pt-4"><button type="button" onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button></div></form></div></div>);
        }

        function ImportModal({ onClose, onDataUpdated }) {
            const [file, setFile] = useState(null); const [result, setResult] = useState(null); const [uploading, setUploading] = useState(false);
            const downloadTemplate = () => { const h=["Hostname","IP","Serial","Type","Brand","Model","Location","Status"]; const s=["SW1","1.1.1.1","SN123","Switch","Cisco","C9300","Rack1","Active"]; const csv="data:text/csv;charset=utf-8,"+h.join(",")+"\n"+s.join(","); const a=document.createElement("a");a.href=encodeURI(csv);a.download="template.csv";a.click(); };
            const handleUpload = (e) => { e.preventDefault(); if(!file) return; setUploading(true); const fd=new FormData(); fd.append('file',file); axios.post('api/import.php',fd,{headers:{'Content-Type':'multipart/form-data'}}).then(res=>{setResult(res.data);setUploading(false);if(res.data.success)onDataUpdated()}).catch(e=>{setResult({success:false,message:e.message});setUploading(false)}) };
            return (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6"><div className="flex justify-between mb-4"><h2 className="font-bold">Import CSV</h2><button onClick={onClose}>✕</button></div><div className="mb-4 text-xs bg-gray-50 p-2 rounded"><button onClick={downloadTemplate} className="text-blue-600 font-bold">Download Template</button></div>{!result ? <form onSubmit={handleUpload}><input type="file" onChange={e=>setFile(e.target.files[0])} className="w-full text-xs mb-4" /><button disabled={uploading} className="bg-green-600 text-white w-full py-2 rounded font-bold">{uploading?"Uploading...":"Upload"}</button></form> : <div><div className={`p-2 rounded mb-2 text-xs ${result.success?'bg-green-100':'bg-red-100'}`}>{result.message}</div><button onClick={()=>{onClose();setResult(null)}} className="bg-gray-800 text-white w-full py-2 rounded">Close</button></div>}</div></div>);
        }

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [inventory, setInventory] = useState([]);
            const [options, setOptions] = useState({ brands: [], types: [], models: [] });
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [locationFilter, setLocationFilter] = useState("");
            const [sortConfig, setSortConfig] = useState({ key: 'hostname', direction: 'ascending' });
            
            // Modal States
            const [isImportOpen, setIsImportOpen] = useState(false);
            const [isDeviceModalOpen, setIsDeviceModalOpen] = useState(false);
            const [editingDevice, setEditingDevice] = useState(null);

            useEffect(() => { if (user) fetchData(); }, [user]);

            const fetchData = () => {
                setLoading(true);
                Promise.all([axios.get('api/inventory.php'), axios.get('api/options.php')])
                .then(([invRes, optRes]) => { 
                    setInventory(Array.isArray(invRes.data) ? invRes.data : []); 
                    setOptions(optRes.data || { brands: [], types: [], models: [] }); 
                    setLoading(false); 
                })
                .catch(err => { console.error(err); setLoading(false); });
            };

            const processedInventory = useMemo(() => {
                let items = [...inventory];
                if (searchTerm) { const s = searchTerm.toLowerCase(); items = items.filter(i => (i.hostname.toLowerCase().includes(s) || (i.ip_address && i.ip_address.includes(s)) || (i.serial_number && i.serial_number.toLowerCase().includes(s)))); }
                if (locationFilter) items = items.filter(i => i.location === locationFilter);
                if (sortConfig.key) { items.sort((a, b) => { let valA = a[sortConfig.key] ? a[sortConfig.key].toString().toLowerCase() : ''; let valB = b[sortConfig.key] ? b[sortConfig.key].toString().toLowerCase() : ''; if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1; if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1; return 0; }); }
                return items;
            }, [inventory, searchTerm, locationFilter, sortConfig]);

            const uniqueLocations = useMemo(() => [...new Set(inventory.map(i => i.location).filter(Boolean))].sort(), [inventory]);

            if (!user) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-slate-100">
                            <div className="mb-6 text-center">
                                <h2 className="text-2xl font-bold text-slate-800">InfraInv</h2>
                                <p className="text-slate-400 text-sm">Asset Management System</p>
                            </div>
                            <form onSubmit={(e) => { e.preventDefault(); const u=e.target.username.value; const p=e.target.password.value; axios.post('api/login.php', {username:u, password:p}).then(res=>{if(res.data.success && res.data.user) setUser(res.data.user)}).catch(()=>alert("Login Failed")); }} className="space-y-4">
                                <input name="username" className="w-full border p-2 rounded" placeholder="Username" />
                                <input name="password" type="password" className="w-full border p-2 rounded" placeholder="Password" />
                                <button className="w-full bg-slate-900 text-white font-bold py-3 rounded">Sign In</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <Layout user={user} currentView={view} onViewChange={setView} onLogout={()=>setUser(null)}>
                    {view === 'dashboard' && (
                        <div className="p-8">
                            <div className="flex justify-between items-end mb-6">
                                <div><h2 className="text-2xl font-bold text-slate-800">Inventory</h2></div>
                                <div className="flex gap-2">
                                    <a href="api/export.php" target="_blank" className="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm font-medium hover:bg-slate-50 transition-colors"><i className="ph ph-download-simple"></i> Export</a>
                                    {user.role !== 'viewer' && (<>
                                        <button onClick={()=>setIsImportOpen(true)} className="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm font-medium hover:bg-slate-50 transition-colors"><i className="ph ph-upload-simple"></i> Import</button>
                                        <button onClick={()=>{setEditingDevice(null);setIsDeviceModalOpen(true)}} className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md shadow-blue-200 flex items-center gap-2 text-sm font-bold hover:bg-blue-700 transition-colors"><i className="ph ph-plus"></i> Add Device</button>
                                    </>)}
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <StatCard label="Total Assets" value={inventory.length} icon="ph-cube" color="bg-blue-500" />
                                <StatCard label="Risks" value={inventory.filter(i=>getEOSMeta(i.eos_date).isRisk).length} icon="ph-warning" color="bg-red-500" />
                                <StatCard label="Locations" value={uniqueLocations.length} icon="ph-map-pin" color="bg-purple-500" />
                            </div>
                            <div className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-[calc(100vh-320px)]">
                                <div className="p-4 border-b border-slate-100 flex gap-4 bg-white">
                                    <input type="text" placeholder="Search..." className="flex-1 pl-4 pr-4 py-2 border border-slate-200 rounded-lg text-sm" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                    <select className="border border-slate-200 rounded-lg px-3 py-2 text-sm" value={locationFilter} onChange={e=>setLocationFilter(e.target.value)}><option value="">All Locations</option>{uniqueLocations.map(l=><option key={l} value={l}>{l}</option>)}</select>
                                    <button onClick={fetchData} className="text-slate-400 hover:text-blue-600"><i className="ph ph-arrows-clockwise text-xl"></i></button>
                                </div>
                                <div className="flex-1 overflow-auto table-container bg-white">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="sticky-header text-xs font-semibold text-slate-500 uppercase tracking-wider">
                                            <tr>{[{k:'hostname',l:'Hostname'},{k:'ip_address',l:'IP Address'},{k:'brand',l:'Brand'},{k:'model',l:'Model'},{k:'location',l:'Location'},{k:'status',l:'Status'}].map(h=>(<th key={h.k} onClick={()=>setSortConfig({key:h.k, direction:sortConfig.key===h.k&&sortConfig.direction==='ascending'?'descending':'ascending'})} className="px-6 py-3 cursor-pointer hover:bg-slate-100 select-none">{h.l}</th>))}{user.role!=='viewer' && <th className="px-6 py-3 text-right">Actions</th>}</tr>
                                        </thead>
                                        <tbody className="text-sm text-slate-700 divide-y divide-slate-100">
                                            {processedInventory.map(item => {
                                                const eos = getEOSMeta(item.eos_date);
                                                return (<tr key={item.id} className="hover:bg-slate-50 transition-colors group"><td className="px-6 py-3"><div className="font-semibold text-slate-900">{item.hostname}</div><div className="text-[11px] text-slate-400 font-mono">{item.asset_id || ''}</div></td><td className="px-6 py-3 font-mono text-slate-600">{item.ip_address}</td><td className="px-6 py-3">{item.brand}</td><td className="px-6 py-3"><div>{item.model}</div>{item.eos_date && <div className={`inline-block mt-1 ${eos.class}`}>{eos.label}</div>}</td><td className="px-6 py-3 text-slate-500">{item.location}</td><td className="px-6 py-3"><span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${item.status==='Active'?'bg-emerald-100 text-emerald-700':item.status==='Decommissioned'?'bg-red-100 text-red-700':'bg-blue-100 text-blue-700'}`}>{item.status}</span></td>{user.role!=='viewer' && (<td className="px-6 py-3 text-right"><div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={()=>{setEditingDevice(item);setIsDeviceModalOpen(true)}} className="text-blue-600"><i className="ph ph-pencil-simple text-lg"></i></button><button onClick={()=>{if(confirm("Delete?")) axios.delete('api/inventory.php',{data:{id:item.id}}).then(fetchData)}} className="text-red-600"><i className="ph ph-trash text-lg"></i></button></div></td>)}</tr>);
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {view === 'settings' && <SettingsView options={options} onDataUpdated={fetchData} currentUser={user} />}
                    {view === 'logs' && <LogsView />}

                    {/* CONDITIONALLY RENDER MODALS TO PREVENT HOOK ERRORS */}
                    {isDeviceModalOpen && <DeviceModal isOpen={true} onClose={()=>setIsDeviceModalOpen(false)} onSave={(fd)=>{if(!fd.brand_id||!fd.model_id)return alert("Missing Brand/Model"); const m=editingDevice?'put':'post'; const p=editingDevice?{...fd, id:editingDevice.id}:fd; axios({method:m, url:'api/inventory.php', data:p}).then(res=>{if(res.data.success||res.data.message.includes('success')){setIsDeviceModalOpen(false);setEditingDevice(null);fetchData()}else alert(res.data.message)}).catch(e=>alert("Error"))}} options={options} initialData={editingDevice} />}
                    
                    {isImportOpen && <ImportModal onClose={()=>setIsImportOpen(false)} onDataUpdated={fetchData} />}
                </Layout>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>